<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <style>
    body { background-color: linen }
    h1 { color: maroon }
    h2 { color: maroon }
  </style>

  <title>Minky</title>
</head>

<body>
  <div class="test">
    <!-- Page Content -->
    <div id="page-content-wrapper" style="margin-bottom: 10px;">
      <h1>Minky: Minkowski sums of images</h1>

      <!-- Image Chooser for selecteding which images to add: -->
      <div id="ImageChooser">
        <h2>Select images:</h2>
        <!-- Choice of images will go here -->
      </div>

      <form>
        <h2>Select combining function:</h2>
        <input type="radio" name="combine" onchange="changeCombine(1);" value="1" checked="checked"> Minimum
        <input type="radio" name="combine" onchange="changeCombine(2);" value="2"> Average
        <input type="radio" name="combine" onchange="changeCombine(3);" value="3"> Multiply
      </form>

      <h2>The Minkowski Equation:</h2>
      <table>
        <tr>
          <td><div id="IMG-1"></div></td>
          <td><img src='images/MinkowskiSum.png'></div></td>
          <td><div id="IMG-2"></div></td>
          <td><img src='images/EqualsSymbol.png'></div></td>
          <td><div id="IMG-SUM"></div></td>
        </tr>
      </table>
    </div>
  </div>

  <script src="dist/gpu-browser.min.js"></script>

  <script>
    const gpu = new GPU({ mode: 'gpu' });
    var imageSize = 100

    //========================================================================
    // This routine will be run for each pixel of the output with:
    //   this.thread.x as the x coordinate of the output
    //   this.thread.y as the y coordinate of the output
    const kernel = gpu.createKernel(function(imagea, imageb, combine) {
      const imageawidth  = 100
      const imagebwidth  = 100
      const imageaheight = 100
      const imagebheight = 100
      const imageoutwidth   = imageawidth  + imagebwidth  - 1
      const imageoutheight  = imageaheight + imagebheight - 1

      const axmin = Math.max(0, this.thread.x - imagebwidth + 1)
      const axmax = Math.min(this.thread.x, imageawidth - 1)
      const aymin = Math.max(0, this.thread.y - imagebheight + 1)
      const aymax = Math.min(this.thread.y, imageaheight - 1)

      var maxr = 0; var maxg = 0; var maxb = 0; var maxa = 0
      for (let ay = aymin; ay <= aymax; ay++) {
        for (let ax = axmin; ax <= axmax; ax++) {
          const pixela = imagea[ay][ax]
          const pixelb = imageb[this.thread.y-ay][this.thread.x-ax]

          //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
          // The following may not be succinct but it happens O(n^4) times so trying to keep efficient!
          if (combine == 1) {
            // For each channel, we take the minimum of the two pixel values and then look for the maximum of all of those:
            maxr = Math.max(maxr, Math.min(pixela[0], pixelb[0]))
            maxg = Math.max(maxg, Math.min(pixela[1], pixelb[1]))
            maxb = Math.max(maxb, Math.min(pixela[2], pixelb[2]))
            maxa = Math.max(maxa, Math.min(pixela[3], pixelb[3]))
          }
          if (combine == 2) {
            // For each channel take the average of the two pixel values and then look for the maximum of all of those:
            maxr = Math.max(maxr, (pixela[0] + pixelb[0]) / 2)
            maxg = Math.max(maxg, (pixela[1] + pixelb[1]) / 2)
            maxb = Math.max(maxb, (pixela[2] + pixelb[2]) / 2)
            maxa = Math.max(maxa, (pixela[3] + pixelb[3]) / 2)
          }
          if (combine == 3) {
            maxr = Math.max(maxr, pixela[0] * pixelb[0])
            maxg = Math.max(maxg, pixela[1] * pixelb[1])
            maxb = Math.max(maxb, pixela[2] * pixelb[2])
            maxa = Math.max(maxa, pixela[3] * pixelb[3])
          }
          //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        }
      }
      this.color(maxr, maxg, maxb, maxa)
    })
    .setGraphical(true)
    .setOutput([200, 200])

    //========================================================================
    function doMinkowski() {
      kernel(image1, image2, combineValue);
    }

    //========================================================================
    const imageNames = ['Plus', 'Minus', 'Multiply', 'Divide', 'Happy', 'Sad', 'Orb', 'RedTriangle', 'Cool']
    //var files = fs.readdirSync('/images/'); ??
    const defaultImage1 = 'Plus'
    const defaultImage2 = 'Multiply'

    createTableOfImages('ImageChooser', imageNames)

    const image1 = loadImage(defaultImage1)
    const image2 = loadImage(defaultImage2)

    // Set up two equation images and their minkowski sum:
    document.getElementById('IMG-1').appendChild(image1);
    document.getElementById('IMG-2').appendChild(image2);
    document.getElementById('IMG-SUM').appendChild(kernel.canvas);

    // Use to cycle between selected images
    var imageChoice = 0
    // Use to select combining function
    var combineValue = 1

    const totalImages = 2;
    let loadedImages = 0;

    function onload() {
      loadedImages++;
      if (loadedImages === totalImages) {
        doMinkowski()
      }
    };
    //========================================================================
    // Helper functions

    function loadImage(imageName) {
      const image = document.createElement('img')
      image.src = 'images/' + imageName + '.png'
      image.onload = onload
      return image
    }

    function createTableOfImages(insertAtThisId, imageNames){
      var tbl  = document.createElement('table');
      var tr = tbl.insertRow();
      for (imageNum in imageNames) {
        imageName = imageNames[imageNum]
        var td = tr.insertCell();

        const image = document.createElement('img');
        image.src = 'images/' + imageName + '.png';
        image.id = imageName
        image.onclick = function() { selectImage(this) }
        td.appendChild(image)
      }
      document.getElementById(insertAtThisId).appendChild(tbl)
    }

    function selectImage(image) {
      console.log(`Clicked image ${image.id}`)
      const imagePath = 'images/' + image.id + '.png';
      if (imageChoice == 0) {
        image1.src = imagePath
        imageChoice = 1
      } else {
        image2.src = imagePath
        imageChoice = 0
      }
      doMinkowski()
    }

    function changeCombine(newCombineValue) {
      console.log("Combine value changed to " + newCombineValue)
      combineValue = newCombineValue
      doMinkowski()
    }

  </script>
</body>

</html>
